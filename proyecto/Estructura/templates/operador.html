<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel Operador</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* --- ESTILOS GLOBALES --- */
        body { 
            background-color: #f4f6f9; 
            font-family: 'Poppins', sans-serif; 
            padding-top: 240px; /* Espacio para el header grande */
            font-size: 0.85rem; 
        }

        /* --- HEADER FIJO --- */
        .fixed-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1030;
            background-color: #002b3f; 
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 15px; 
            border-bottom: 5px solid white;
        }

        /* Tabs de NavegaciÃ³n */
        .nav-pills .nav-link {
            color: rgba(255,255,255,0.7);
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; margin-right: 5px; width: 100%;
        }
        .nav-pills .nav-link.active {
            background-color: white; color: #002b3f; border-color: white;
        }

        /* Inputs de Filtro */
        .form-control-filter, .form-select-filter {
            background-color: #fff; border: none; border-radius: 6px;
            padding: 8px 10px; font-size: 0.9rem; color: #333; font-weight: 600;
            width: 100%;
        }
        .form-control-filter::placeholder { color: #999; font-weight: 400; }

        /* --- TARJETAS --- */
        .card-bus { 
            border: none; border-radius: 12px; background: #fff;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08); 
            transition: transform 0.2s; overflow: hidden;
        }
        
        .borde-salidas { border-left: 8px solid #dc3545; }
        .borde-llegadas { border-left: 8px solid #198754; }

        .hora-grande { font-size: 2rem; font-weight: 800; color: #212529; line-height: 1; }
        .fecha-small { font-size: 0.75rem; font-weight: 500; color: #888; text-transform: uppercase; }
        .empresa-title { font-size: 0.95rem; font-weight: 700; color: #002b3f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lugar-text { font-size: 1.1rem; font-weight: 700; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .anden-box {
            background-color: #f8f9fa; border: 1px solid #dee2e6;
            border-radius: 8px; padding: 2px 10px; text-align: center; min-width: 50px;
        }
        .anden-num { font-size: 1.4rem; font-weight: 800; color: #212529; line-height: 1;}

        /* ESTADOS */
        .estado-container {
            border-radius: 6px; padding: 8px; text-align: center; margin-bottom: 10px;
            font-weight: 700; text-transform: uppercase; font-size: 0.9rem;
            background-color: #f1f3f5; color: #495057;
        }
        .color-anden { color: #155724; background-color: #d4edda; }      
        .color-viaje { color: #084298; background-color: #cfe2ff; }      
        .color-demorado { color: #856404; background-color: #fff3cd; }    
        .color-reset { color: #383d41; background-color: #e2e3e5; }      

        /* BOTONES */
        .btn-simple {
            width: 100%; padding: 10px 0; font-size: 0.8rem; font-weight: 600;
            border-radius: 6px; border: 1px solid #dee2e6; background-color: #fff; color: #444;
        }
        .btn-simple:active { background-color: #e9ecef; }
        
        .btn-success-opt { border-color: #198754; color: #198754; }
        .btn-primary-opt { border-color: #0d6efd; color: #0d6efd; }
        .btn-warning-opt { border-color: #ffc107; color: #997404; }
        .btn-secondary-opt { border-color: #6c757d; color: #6c757d; }

    </style>
</head>
<body>

    <div class="fixed-header">
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold fs-5">Panel Operador (-2h / +10h)</span>
            <div>
                <span class="badge bg-light text-dark fw-normal me-2">{{ usuario.username }}</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm fw-bold">Salir</a>
            </div>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab">
            <li class="nav-item flex-fill">
                <button class="nav-link active" onclick="filtrarPorTipo('todos', this)">TODOS</button>
            </li>
            <li class="nav-item flex-fill">
                <button class="nav-link" onclick="filtrarPorTipo('salidas', this)">ðŸ“¤ SALIDAS</button>
            </li>
            <li class="nav-item flex-fill">
                <button class="nav-link" onclick="filtrarPorTipo('llegadas', this)">ðŸ“¥ LLEGADAS</button>
            </li>
        </ul>

        <div class="row g-2 p-2 bg-white bg-opacity-10 rounded">
            <div class="col-3 col-md-2">
                <input type="text" id="filtroHora" class="form-control form-control-filter text-center" placeholder="Hora" onkeyup="aplicarFiltros()">
            </div>
            <div class="col-4 col-md-4">
                <select id="filtroEmpresa" class="form-select form-select-filter" onchange="aplicarFiltros()">
                    <option value="">Todas las Empresas</option>
                    {% for emp in empresas %}
                        <option value="{{ emp }}">{{ emp }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-3 col-md-4">
                <select id="filtroLugar" class="form-select form-select-filter" onchange="aplicarFiltros()">
                    <option value="">Todos los Destinos</option>
                    {% for lug in lugares %}
                        <option value="{{ lug }}">{{ lug }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-2 col-md-2">
                <input type="text" id="filtroAnden" class="form-control form-control-filter text-center" placeholder="AndÃ©n" onkeyup="aplicarFiltros()">
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 pb-5">
        <div class="row g-3" id="contenedor-tarjetas">
            
            {% for bus in recorridos %}
            <div class="col-12 col-sm-6 col-lg-4 col-xl-3 tarjeta-item"
                 data-tipo="{{ bus.tipo }}"
                 data-hora="{{ bus.hora }}"
                 data-empresa="{{ bus.empresa }}"
                 data-lugar="{{ bus.lugar }}"
                 data-anden="{{ bus.anden }}">
                 
                <div class="card card-bus h-100 borde-{{ bus.tipo }}">
                    <div class="card-body p-3 d-flex flex-column">
                        
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="fecha-small">{{ bus.fecha }}</span>
                                <div class="hora-grande">{{ bus.hora }}</div>
                                {% if bus.tipo == 'salidas' %}
                                    <span class="badge bg-danger" style="font-size: 0.6rem;">SALIDA</span>
                                {% else %}
                                    <span class="badge bg-success" style="font-size: 0.6rem;">LLEGADA</span>
                                {% endif %}
                            </div>
                            <div class="anden-box">
                                <small class="text-muted d-block" style="font-size: 0.6rem;">ANDÃ‰N</small>
                                <div class="anden-num">{{ bus.anden }}</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="empresa-title">{{ bus.empresa }}</div>
                            <div class="lugar-text">{{ bus.lugar }}</div>
                        </div>

                        <div class="mt-auto">
                            <div id="box-estado-{{ bus.id }}" class="estado-container 
                                {% if bus.estado == 'En AndÃ©n' %}color-anden
                                {% elif bus.estado == 'En Recorrido' %}color-viaje
                                {% elif bus.estado == 'Demorado' %}color-demorado
                                {% else %}color-reset{% endif %}">
                                <span id="texto-estado-{{ bus.id }}">{{ bus.estado }}</span>
                            </div>

                            <div class="row g-2">
                                <div class="col-6"><button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'En AndÃ©n', 'color-anden')" class="btn btn-simple btn-success-opt">AndÃ©n</button></div>
                                <div class="col-6"><button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'En Recorrido', 'color-viaje')" class="btn btn-simple btn-primary-opt">Viaje</button></div>
                                <div class="col-6"><button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'Demorado', 'color-demorado')" class="btn btn-simple btn-warning-opt">Demora</button></div>
                                <div class="col-6"><button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'Sin estado', 'color-reset')" class="btn btn-simple btn-secondary-opt">Reset</button></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center py-5 mt-5">
                <h4 class="text-muted fw-bold">No hay recorridos en las prÃ³ximas horas.</h4>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variable global para el filtro de pestaÃ±as
        let tipoActual = 'todos'; 

        // 1. FILTRAR POR TIPO (PestaÃ±as)
        function filtrarPorTipo(tipo, boton) {
            tipoActual = tipo;
            
            // Actualizar estilo botones
            document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
            boton.classList.add('active');

            aplicarFiltros();
        }

        // 2. APLICAR TODOS LOS FILTROS (LÃ³gica central)
        function aplicarFiltros() {
            // Obtener valores de inputs
            const fHora = document.getElementById('filtroHora').value.toLowerCase().trim();
            const fEmpresa = document.getElementById('filtroEmpresa').value.toLowerCase().trim();
            const fLugar = document.getElementById('filtroLugar').value.toLowerCase().trim();
            const fAnden = document.getElementById('filtroAnden').value.toLowerCase().trim();

            const tarjetas = document.querySelectorAll('.tarjeta-item');

            tarjetas.forEach(card => {
                // Obtener datos de la tarjeta
                const dataTipo = card.getAttribute('data-tipo');
                const dataHora = card.getAttribute('data-hora').toLowerCase();
                const dataEmpresa = card.getAttribute('data-empresa').toLowerCase();
                const dataLugar = card.getAttribute('data-lugar').toLowerCase();
                const dataAnden = card.getAttribute('data-anden').toLowerCase();

                let mostrar = true;

                // 1. Filtro Tipo (PestaÃ±a)
                if (tipoActual !== 'todos' && dataTipo !== tipoActual) mostrar = false;

                // 2. Filtro Hora
                if (fHora && !dataHora.includes(fHora)) mostrar = false;

                // 3. Filtro Empresa (Coincidencia exacta por Select, o parcial si fuera texto)
                // Al ser Select, suele ser exacta, pero includes funciona bien.
                if (fEmpresa && !dataEmpresa.includes(fEmpresa)) mostrar = false;

                // 4. Filtro Lugar
                if (fLugar && !dataLugar.includes(fLugar)) mostrar = false;

                // 5. Filtro AndÃ©n
                if (fAnden && !dataAnden.includes(fAnden)) mostrar = false;

                // Aplicar visibilidad
                card.style.display = mostrar ? 'block' : 'none';
            });
        }

        // 3. CAMBIAR ESTADO (AJAX)
        function cambiarEstado(id, tipo, nuevoEstado, claseColor) {
            document.body.style.cursor = 'wait';
            const formData = new FormData();
            formData.append('id', id);
            formData.append('tipo', tipo);
            formData.append('estado', nuevoEstado);

            fetch('/actualizar_estado', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.body.style.cursor = 'default';
                if (data.status === 'success') {
                    const elementoTexto = document.getElementById('texto-estado-' + id);
                    const elementoBox = document.getElementById('box-estado-' + id);
                    if (elementoTexto && elementoBox) {
                        elementoTexto.innerText = nuevoEstado;
                        elementoBox.classList.remove('color-anden', 'color-viaje', 'color-demorado', 'color-reset');
                        elementoBox.classList.add(claseColor);
                    }
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                document.body.style.cursor = 'default';
                console.error('Error:', error);
                alert("Error de conexiÃ³n");
            });
        }

        // Auto-refresh cada 60s (Solo si no estÃ¡s escribiendo)
        let timer = setTimeout(() => { location.reload(); }, 60000);
        
        // Detener refresh si el usuario toca algo
        document.querySelectorAll('input, select, button').forEach(el => {
            el.addEventListener('click', () => clearTimeout(timer));
            el.addEventListener('keyup', () => clearTimeout(timer));
        });
    </script>
</body>
</html>