<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel Operador - Terminal</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root {
            --operador-navbar: #002b3f; /* Azul Corporativo */
            --operador-fondo: #f4f6f9;
        }

        body { 
            background-color: var(--operador-fondo); 
            font-family: 'Poppins', sans-serif; 
            /* CORRECCIÓN: Eliminamos font-size: 0.85rem para que tenga el tamaño normal del Admin */
            padding-top: 300px; /* Espacio reservado para el encabezado fijo */
        }

        /* --- CONTENEDOR FIJO (Para que no se mueva al hacer scroll) --- */
        .fixed-header-wrapper {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1030;
            background-color: var(--operador-fondo); /* Fondo para tapar el contenido al hacer scroll */
            padding-bottom: 10px;
        }

        /* --- BLOQUE 1: NAVBAR (Igual al Admin) --- */
        .navbar-operador {
            background-color: var(--operador-navbar);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        /* --- BLOQUE 2: TARJETA DE FILTROS (Igual al Admin) --- */
        .card-filtros {
            background-color: var(--operador-navbar);
            border: none;
            border-radius: 15px; /* Bordes redondeados como en Admin */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 1rem;
            margin-top: 1.5rem; /* Separación igual a Admin */
        }

        /* --- NAVEGACIÓN (TABS) --- */
        .nav-pills .nav-link {
            color: rgba(255,255,255,0.7);
            font-weight: 500; border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; margin-right: 5px; width: 100%;
        }
        .nav-pills .nav-link.active {
            background-color: white; color: var(--operador-navbar); font-weight: 600; border-color: white;
        }

        /* --- TARJETAS DE BUSES --- */
        .card-bus { 
            border: none; border-radius: 12px; background: #fff;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08); 
            transition: transform 0.2s; overflow: hidden;
        }
        .borde-salidas { border-left: 8px solid #dc3545; }
        .borde-llegadas { border-left: 8px solid #198754; }

        .hora-grande { font-size: 2rem; font-weight: 800; color: #212529; line-height: 1; }
        .fecha-small { font-size: 0.75rem; font-weight: 500; color: #888; text-transform: uppercase; }
        .empresa-title { font-size: 0.95rem; font-weight: 700; color: var(--operador-navbar); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lugar-text { font-size: 1.1rem; font-weight: 700; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .anden-box {
            background-color: #f8f9fa; border: 1px solid #dee2e6;
            border-radius: 8px; padding: 2px 10px; text-align: center; min-width: 50px;
        }
        .anden-num { font-size: 1.4rem; font-weight: 800; color: #212529; line-height: 1;}

        /* --- ESTADOS --- */
        .estado-container {
            border-radius: 6px; padding: 8px; text-align: center; margin-bottom: 10px;
            font-weight: 700; text-transform: uppercase; font-size: 0.9rem;
            background-color: #f1f3f5; color: #495057;
            transition: all 0.3s ease;
        }
        .color-anden { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }      
        .color-viaje { color: #084298; background-color: #cfe2ff; border: 1px solid #b6d4fe; }      
        .color-demorado { color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; }
        .color-finalizado { color: #7c1616; background-color: #ec9292; border: 1px solid #a35e5e; }
        .color-reset { color: #383d41; background-color: #e2e3e5; border: 1px solid #d6d8db; }      

        /* --- BOTONES --- */
        .btn-operador-fijo {
            width: 100%; padding: 8px 0; font-size: 0.85rem; font-weight: 600;
            border-radius: 6px; transition: all 0.2s;
            background-color: #ffffff; color: var(--operador-navbar); border: 1px solid var(--operador-navbar); 
        }
        .btn-operador-fijo:hover, .btn-operador-fijo:active { 
            background-color: var(--operador-navbar); color: #ffffff; transform: scale(0.98); 
        }
    </style>
</head>
<body>

<div class="fixed-header-wrapper">
    
    <nav class="navbar navbar-expand-lg navbar-dark navbar-operador">
        <div class="container">
            <a class="navbar-brand" href="#">
                PANEL DE OPERADOR
            </a>
            
            <div class="ms-auto d-flex align-items-center gap-2">
                {% if current_user.rol == 'admin' %}
                <a href="{{ url_for('admin_bp.admin_panel') }}" class="btn btn-dark btn-sm text-white">
                    <i class="bi bi-shield-lock"></i> Panel Admin
                </a>
                {% endif %}

                <span class="navbar-text text-white me-2 d-none d-md-block small">| {{ usuario.username }}</span>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-sm">Salir</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card-filtros">
            
            <ul class="nav nav-pills mb-3" id="pills-tab">
                <li class="nav-item flex-fill">
                    <button class="nav-link active" onclick="filtrarPorTipo('todos', this)">TODOS</button>
                </li>
                <li class="nav-item flex-fill">
                    <button class="nav-link" onclick="filtrarPorTipo('salidas', this)">
                        <i class="bi bi-box-arrow-right me-1"></i> SALIDAS
                    </button>
                    
                </li>
                <li class="nav-item flex-fill">
                    <button class="nav-link" onclick="filtrarPorTipo('llegadas', this)">
                         <i class="bi bi-box-arrow-in-left me-1"></i> LLEGADAS
                    </button>
                </li>
                
            </ul>

            <div class="row g-2 align-items-end">
                <div class="col-3 col-md-2">
                    <label class="form-label small fw-bold text-white">Hora</label>
                    <input type="text" id="filtroHora" class="form-control form-control-sm text-center" placeholder="00:00" maxlength="5" onkeyup="aplicarFiltros()">
                </div>
                <div class="col-4 col-md-4">
                    <label class="form-label small fw-bold text-white">Empresa</label>
                    <select id="filtroEmpresa" class="form-select form-select-sm" onchange="aplicarFiltros()">
                        <option value="">Todas</option>
                        {% for emp in empresas %}
                            <option value="{{ emp }}">{{ emp }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-3 col-md-4">
                    <label class="form-label small fw-bold text-white">Lugar</label>
                    <select id="filtroLugar" class="form-select form-select-sm" onchange="aplicarFiltros()">
                        <option value="">Todos</option>
                        {% for lug in lugares %}
                            <option value="{{ lug }}">{{ lug }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-2 col-md-2">
                    <label class="form-label small fw-bold text-white">Andén</label>
                    <input type="text" id="filtroAnden" class="form-control form-control-sm text-center" placeholder="#" onkeyup="aplicarFiltros()">
                </div>
            </div>

        </div>
    </div>
</div>

<div class="container-fluid px-3 pb-5">
    <div class="row g-3" id="contenedor-tarjetas">
        
        {% for bus in recorridos %}
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3 tarjeta-item"
             data-tipo="{{ bus.tipo }}"
             data-hora="{{ bus.hora }}"
             data-empresa="{{ bus.empresa }}"
             data-lugar="{{ bus.lugar }}"
             data-anden="{{ bus.anden }}">
             
            <div class="card card-bus h-100 borde-{{ bus.tipo }}">
                <div class="card-body p-3 d-flex flex-column">
                    
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="fecha-small">{{ bus.fecha }}</span>
                            <div class="hora-grande">{{ bus.hora }}</div>
                            {% if bus.tipo == 'salidas' %}
                                <span class="badge bg-danger" style="font-size: 0.6rem;">SALIDA</span>
                            {% else %}
                                <span class="badge bg-success" style="font-size: 0.6rem;">LLEGADA</span>
                            {% endif %}
                        </div>
                        <div class="anden-box">
                            <small class="text-muted d-block" style="font-size: 0.6rem;">ANDÉN</small>
                            <div class="anden-num">{{ bus.anden }}</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="empresa-title">{{ bus.empresa }}</div>
                        <div class="lugar-text">{{ bus.lugar }}</div>
                    </div>

                    <div class="mt-auto">
                        <div id="box-estado-{{ bus.id }}" class="estado-container 
                            {% if bus.estado == 'En Andén' %}color-anden
                            {% elif bus.estado == 'En Recorrido' %}color-viaje
                            {% elif bus.estado == 'Demorado' %}color-demorado
                            {% elif bus.estado == 'Finalizado' %}color-finalizado
                            {% else %}color-reset{% endif %}">
                            <span id="texto-estado-{{ bus.id }}">{{ bus.estado }}</span>
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'En Andén', 'color-anden')" class="btn btn-operador-fijo">
                                    <i class="bi bi-megaphone"></i> Andén
                                </button>
                            </div>
                            <div class="col-6">
                                <button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'En Recorrido', 'color-viaje')" class="btn btn-operador-fijo">
                                    <i class="bi bi-play-fill"></i> Viaje
                                </button>
                            </div>
                            <div class="col-12">
                                <button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'Demorado', 'color-demorado')" class="btn btn-operador-fijo">
                                    <i class="bi bi-clock-history"></i> Demora
                                </button>
                            </div>
                            <div class="col-12">
                                <button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'Finalizado', 'color-finalizado')" class="btn btn-operador-fijo">
                                    <i class="bi bi-check-circle-fill"></i> Finalizado
                                </button>
                            </div>
                            <div class="col-12">
                                <button onclick="cambiarEstado('{{ bus.id }}', '{{ bus.tipo }}', 'Programado', 'color-reset')" class="btn btn-operador-fijo bg-secondary">
                                    <span class="text-dark fw-bold">
                                    <i class="bi bi-arrow-counterclockwise"></i> Resetear a Programado
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5 mt-5">
            <h4 class="text-muted fw-bold">No hay recorridos programados.</h4>
            <p class="text-muted">El sistema muestra 2 horas antes y 10 horas después.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let tipoActual = 'todos'; 

    function filtrarPorTipo(tipo, boton) {
        tipoActual = tipo;
        document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
        boton.classList.add('active');
        aplicarFiltros();
    }

    document.getElementById('filtroHora').addEventListener('input', function (e) {
        var x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,2})/);
        e.target.value = !x[2] ? x[1] : x[1] + ':' + x[2];
        aplicarFiltros(); 
    });

    function aplicarFiltros() {
        const fHora = document.getElementById('filtroHora').value.toLowerCase().trim();
        const fEmpresa = document.getElementById('filtroEmpresa').value.toLowerCase().trim();
        const fLugar = document.getElementById('filtroLugar').value.toLowerCase().trim();
        const fAnden = document.getElementById('filtroAnden').value.toLowerCase().trim();

        document.querySelectorAll('.tarjeta-item').forEach(card => {
            const dataTipo = card.getAttribute('data-tipo');
            const dataHora = card.getAttribute('data-hora').toLowerCase();
            const dataEmpresa = card.getAttribute('data-empresa').toLowerCase();
            const dataLugar = card.getAttribute('data-lugar').toLowerCase();
            const dataAnden = card.getAttribute('data-anden').toLowerCase();

            let mostrar = true;
            if (tipoActual !== 'todos' && dataTipo !== tipoActual) mostrar = false;
            if (fHora && !dataHora.includes(fHora)) mostrar = false;
            if (fEmpresa && !dataEmpresa.includes(fEmpresa)) mostrar = false;
            if (fLugar && !dataLugar.includes(fLugar)) mostrar = false;
            if (fAnden && !dataAnden.includes(fAnden)) mostrar = false;

            card.style.display = mostrar ? 'block' : 'none';
        });
    }

    function cambiarEstado(id, tipo, nuevoEstado, claseColor) {
        document.body.style.cursor = 'wait';
        
        const formData = new FormData();
        formData.append('id', id);
        formData.append('tipo', tipo);
        formData.append('estado', nuevoEstado);

        fetch('/actualizar_estado', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.body.style.cursor = 'default';
            if (data.status === 'success') {
                const texto = document.getElementById('texto-estado-' + id);
                const box = document.getElementById('box-estado-' + id);
                
                if (texto && box) {
                    texto.innerText = nuevoEstado;
                    box.classList.remove('color-anden', 'color-viaje', 'color-demorado', 'color-reset');
                    box.classList.add(claseColor);
                }
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(error => {
            document.body.style.cursor = 'default';
            console.error('Error:', error);
            alert("Error de conexión con el servidor.");
        });
    }

    let timer = setTimeout(() => { location.reload(); }, 60000);
    
    document.querySelectorAll('input, select, button').forEach(el => {
        el.addEventListener('click', () => clearTimeout(timer));
        el.addEventListener('keyup', () => clearTimeout(timer));
    });
</script>
</body>
</html>