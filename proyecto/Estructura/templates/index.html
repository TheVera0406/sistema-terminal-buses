<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla Terminal Coyhaique</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        /* 1. PALETA DE COLORES */
        :root {
            --color-fondo:    #f4f6f9; 
            --color-rojo:     #E53935;   
            --color-verde:    #2e7d32;  
            --color-celeste:  #002b3f;  
            --color-azul:     #002b3f;   
            --color-blanco:   #ffffff;   
        }

        /* 2. ESTILOS GENERALES */
        body { 
            background-color: var(--color-fondo); 
            color: #333; 
            font-family: 'Poppins', sans-serif; 
            padding-bottom: 90px; 
            overflow: hidden; 
        }

        .header-top { 
            background-color: var(--color-azul); 
            padding: 15px 30px; 
            border-bottom: 5px solid var(--color-blanco); 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            color: white;
        }

        /* --- TABLAS (8 FILAS) --- */
        .table-container {
            height: 75vh; 
            overflow: hidden; 
            padding: 0 10px; 
        }

        .table {
            border-collapse: separate !important; 
            border-spacing: 0 10px !important; 
            margin-bottom: 0;
            width: 100%;
        }

        /* ENCABEZADOS DE TABLA */
        .table thead th { 
            background-color: transparent;
            color: #000;          
            text-transform: uppercase;
            font-size: 1.1rem;
            font-weight: 800;        
            border-bottom: 4px solid #000; 
            padding-bottom: 8px;
            padding-left: 15px;
        }

        /* FILAS (TARJETAS) */
        .table tbody tr { 
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08); 
            transition: transform 0.2s;
            border-radius: 12px; 
            height: 70px;
        }
        
        .table tbody tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        .table tbody tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

        .table tbody td {
            border: none; 
            padding: 5px 15px;
            vertical-align: middle;
            line-height: 1.1;
        }

        /* --- JERARQUÍA DE FUENTES --- */
        .celda-hora { 
            font-weight: 800; 
            font-size: 2.0rem;
            color: #212529; 
            letter-spacing: -1px;
        }
        
        .celda-empresa { 
            font-weight: 700; 
            color: var(--color-azul); 
            font-size: 1.2rem;
            text-transform: uppercase;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            max-width: 220px;
        }
        
        .celda-destino { 
            font-weight: 800; 
            color: #444; 
            font-size: 1.4rem;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            max-width: 250px;
            letter-spacing: -0.5px;
        }
        
        /* ESTILOS DE ANDÉN */
        .celda-anden { 
            font-weight: 900; 
            font-size: 2.8rem;
            display: block;
            text-align: center;
            line-height: 1;
        }
        .anden-salida { color: var(--color-rojo); }   
        .anden-llegada { color: var(--color-verde); } 

        /* TÍTULOS CÁPSULA */
        .titulo-capsula {
            border-radius: 50px; 
            padding: 10px 30px;
            color: white;
            font-weight: 800;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.6rem;
        }
        .capsula-salida { background-color: var(--color-rojo); }
        .capsula-llegada { background-color: var(--color-verde); }

        /* ESTADOS (Badges) */
        .badge-estado {
            padding: 10px 12px;
            border-radius: 8px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.9rem;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        
        /* Colores de estados */
/* --- COLORES DE ESTADOS (SEGÚN PALETA) --- */
        
        /* 1. En Andén (Verde - Todo OK) */
        .est-anden { 
            background-color: #d1e7dd; 
            color: #0f5132; 
            border: 2px solid #badbcc; 
            animation: parpadeo 1.5s infinite; 
        }
        
        /* 2. En Recorrido (Azul - Información) */
        .est-viaje { 
            background-color: #cfe2ff; 
            color: #084298; 
            border: 2px solid #b6d4fe; 
            animation: parpadeo 1.5s infinite; 
        }
        
        /* 3. Demorado (Amarillo/Naranja - Alerta) */
        .est-demora { 
            background-color: #fff3cd; 
            color: #664d03; 
            border: 2px solid #ffecb5; 
            animation: parpadeo 1.5s infinite; 
        }
        
        /* 4. Finalizado (Rojo Suave / Vino - Terminó) */
        .est-finalizado { 
            background-color: #f8d7da; 
            color: #842029; /* Tono vino */
            border: 2px solid #f5c2c7; 
            animation: parpadeo 1.5s infinite;
        }
        
        /* 6. CANCELADO (Gris Oscuro / Negro - Muerto) */
        .est-cancelado { 
            background-color: #212529; /* Casi negro */
            color: #ffffff; 
            border: 2px solid #000000; 
            animation: parpadeo 1.5s infinite; 
        }

        /* 5. Programado (Gris Claro - Espera) */
        .est-normal { 
            color: #6c757d; 
            font-weight: 700; 
            font-size: 0.85rem; 
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .est-normal { color: #999; font-weight: 600; font-size: 0.8rem; }

        @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .texto-blanco { color: #ffffff; }
        
        .footer-anuncio {
            background-color: var(--color-azul);
            border-top: 5px solid var(--color-blanco);
            z-index: 1000;
            padding: 15px 0; 
        }

        /* --- ESTILOS PARA MARQUESINA (TEXTO QUE SE MUEVE) --- */
        .marquee-wrapper {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            display: block;

        }

        .marquee-content {
            display: inline-block;
            white-space: nowrap;
        }

        /* Clase que activa la animación */
        .hacer-scroll {
            animation: desplazamiento 8s linear infinite alternate; /* 10 segundos ida y vuelta */
        }

        @keyframes desplazamiento {
            0%, 15% { transform: translateX(0); } /* Espera un poco al inicio */
            85%, 100% { transform: translateX(var(--move-x)); } /* Se mueve a la izquierda */
        }
        
    </style>
</head>
<body>

    <div class="header-top d-flex justify-content-between align-items-center px-4">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='LOGO.png') }}" width="110" class="me-4 rounded p-2">
            <div>
                <h1 class="m-0 fw-bold text-uppercase" style="font-size: 2.3rem;">Bienvenido al Terminal de Buses de Coyhaique</h1>
                <p class="m-0 text-white" style="opacity: 1; font-size: 1.3rem;">
                    Programación del día: <span id="fecha-hoy" class="fw-bold texto-blanco"></span>
                </p>
            </div>
        </div>
        <div class="text-end">
            <h2 id="reloj" class="fw-bold texto-blanco m-0" style="font-family: monospace; font-size: 5.3rem; line-height: 0.9;">00:00</h2>
        </div>
    </div>

    <div class="container-fluid mt-4 px-4">
        <div class="row g-5"> 
            
            <div class="col-lg-6 mb-3">
                <div class="titulo-capsula capsula-salida">
                    <i class="bi bi-box-arrow-right" style="font-size: 1.8rem;"></i> SALIDAS / DEPARTURES
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 15%">HORA</th>
                                <th style="width: 25%">EMPRESA</th>
                                <th style="width: 30%">DESTINO</th>
                                <th style="width: 10%" class="text-center">ANDÉN</th>
                                <th style="width: 20%" class="text-center">ESTADO</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-salidas-body">
                            {% for fila in salidas %}
                            <tr style="animation: fadeIn 0.4s ease-in-out;">
                                <td class="celda-hora">{{ fila[1].strftime('%H:%M') }}</td>
                                <td class="celda-empresa" title="{{ fila[2] }}">{{ fila[2] }}</td>
                                <td class="celda-destino" title="{{ fila[3] }}">
                                    <div class="marquee-wrapper">
                                        <span class="marquee-content">{{ fila[3] }}</span>
                                    </div>
                                </td>
                                <td><span class="celda-anden anden-salida">{{ fila[4] }}</span></td>
                                <td class="text-center">
                                    {% if fila[6] == 'En Andén' %}
                                        <span class="badge-estado est-anden">En Andén</span>
                                    {% elif fila[6] == 'En Recorrido' %}
                                        <span class="badge-estado est-viaje">En Viaje</span>
                                    {% elif fila[6] == 'Demorado' %}
                                        <span class="badge-estado est-demora">Demorado</span>
                                    {% elif fila[6] == 'Finalizado' %}
                                        <span class="badge-estado est-finalizado">Finalizado</span>
                                    {% elif fila[6] == 'Cancelado' %}
                                        <span class="badge-estado est-cancelado">Cancelado</span>
                                    {% else %}
                                        <span class="est-normal">Programado</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center text-muted p-5 fs-3">No hay salidas próximas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-lg-6 mb-3">
                <div class="titulo-capsula capsula-llegada">
                    <i class="bi bi-box-arrow-in-left" style="font-size: 1.8rem;"></i> LLEGADAS / ARRIVALS
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 15%">HORA</th>
                                <th style="width: 25%">EMPRESA</th>
                                <th style="width: 30%">ORIGEN</th>
                                <th style="width: 10%" class="text-center">ANDÉN</th>
                                <th style="width: 20%" class="text-center">ESTADO</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-llegadas-body">
                            {% for fila in llegadas %}
                            <tr style="animation: fadeIn 0.4s ease-in-out;">
                                <td class="celda-hora">{{ fila[1].strftime('%H:%M') }}</td>
                                <td class="celda-empresa" title="{{ fila[2] }}">{{ fila[2] }}</td>
                                <td class="celda-destino" title="{{ fila[3] }}">
                                    <div class="marquee-wrapper">
                                        <span class="marquee-content">{{ fila[3] }}</span>
                                    </div>
                                </td>
                                <td><span class="celda-anden anden-llegada">{{ fila[4] }}</span></td>
                                <td class="text-center">
                                    {% if fila[6] == 'En Andén' %}
                                        <span class="badge-estado est-anden">En Andén</span>
                                    {% elif fila[6] == 'En Recorrido' %}
                                        <span class="badge-estado est-viaje">En Viaje</span>
                                    {% elif fila[6] == 'Demorado' %}
                                        <span class="badge-estado est-demora">Demorado</span>
                                    {% elif fila[6] == 'Finalizado' %}
                                        <span class="badge-estado est-finalizado">Finalizado</span>
                                    {% elif fila[6] == 'Cancelado' %}
                                        <span class="badge-estado est-cancelado">Cancelado</span>  
                                    {% else %}
                                        <span class="est-normal">Programado</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center text-muted p-5 fs-3">No hay llegadas próximas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="fixed-bottom footer-anuncio text-white text-center">
        <h3 id="texto-anuncio" class="m-0 fw-bold text-uppercase texto-blanco" style="font-size: 1.8rem;">
            Cargando...
        </h3>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /* RELOJ */
        function actualizarReloj() {
            const ahora = new Date();
            const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('fecha-hoy').textContent = ahora.toLocaleDateString('es-ES', opcionesFecha);
            document.getElementById('reloj').textContent = ahora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        }
        setInterval(actualizarReloj, 1000);
        actualizarReloj();

        /* PAGINACIÓN - 8 FILAS */
        function iniciarPaginacion(idBody) {
            const filas = document.querySelectorAll(`#${idBody} tr`);
            const totalFilas = filas.length;
            const filasPorPagina = 8; 
            let indiceActual = 0;

            if (totalFilas <= filasPorPagina) {
                filas.forEach(fila => fila.style.display = 'table-row');
                return;
            }

            function mostrarBloque() {
                filas.forEach(fila => fila.style.display = 'none');
                let fin = indiceActual + filasPorPagina;
                
                for (let i = indiceActual; i < fin; i++) {
                    if (filas[i]) { 
                        filas[i].style.display = 'table-row';
                    }
                }
                indiceActual += filasPorPagina;
                if (indiceActual >= totalFilas) {
                    indiceActual = 0;
                }
                activarMarquesina();
            }
            mostrarBloque();
            setInterval(mostrarBloque, 10000); 
        }
        iniciarPaginacion('tabla-salidas-body');
        iniciarPaginacion('tabla-llegadas-body');

        /* NOTICIAS */
        const anuncios = {{ noticias_db | tojson }};
        let indiceAnuncio = 0;
        const elementoAnuncio = document.getElementById('texto-anuncio');
        
        function rotarAnuncios() {
            if (anuncios.length === 0) {
                elementoAnuncio.textContent = "Bienvenido al Terminal de Buses de Coyhaique"; 
                return;
            }
            elementoAnuncio.style.opacity = 0; 
            setTimeout(() => {
                elementoAnuncio.textContent = anuncios[indiceAnuncio];
                elementoAnuncio.style.opacity = 1; 
                indiceAnuncio = (indiceAnuncio + 1) % anuncios.length;
            }, 500);
        }
        elementoAnuncio.style.transition = "opacity 0.5s";
        
        if (anuncios.length > 0) {
            rotarAnuncios();
            setInterval(rotarAnuncios, 8000); 
        } else {
             elementoAnuncio.textContent = "Bienvenido al Terminal de Buses de Coyhaique";
        }

        /* AUTO REFRESH */
        setTimeout(() => { window.location.reload(); }, 180000); 


        // Función para calcular si el texto es largo y moverlo
        function activarMarquesina() {
            const textos = document.querySelectorAll('.marquee-content');
            
            textos.forEach(texto => {
                const wrapper = texto.parentElement;
                // Reiniciamos para medir bien
                texto.style.removeProperty('--move-x');
                texto.classList.remove('hacer-scroll');

                const anchoTexto = texto.scrollWidth;
                const anchoVisible = wrapper.clientWidth;

                // Si el texto es más grande que la celda (+10px de margen)
                if (anchoTexto > anchoVisible) {
                    const diferencia = anchoVisible - anchoTexto; 
                    // Guardamos la distancia exacta que debe recorrer
                    texto.style.setProperty('--move-x', (diferencia - 20) + 'px'); 
                    texto.classList.add('hacer-scroll');
                }
            });
        }        

    </script>
</body>
</html>